# ğŸ›ï¸ ç»ˆææœåŠ¡å™¨æ¶æ„ï¼šæ•°æ®å³åŸºç¡€è®¾æ–½ (Infrastructure as Data)

**è®¾è®¡ç›®æ ‡**ï¼š

1.  **åŸå­çº§è¿ç§»**ï¼š`rsync /data` åˆ°æ–°æœåŠ¡å™¨ = è¿ç§»å®Œæˆã€‚
2.  **æƒé™é›¶ç„¦è™‘**ï¼šé€šè¿‡ç»Ÿä¸€ UID/GID ç­–ç•¥ï¼Œå½»åº•è§£å†³â€œPermission Deniedâ€ã€‚
3.  **æ¶æ„è§£è€¦**ï¼šæ‰€æœ‰æœåŠ¡äº’ä¸ä¾èµ–å®¿ä¸»æœºç¯å¢ƒï¼Œåªä¾èµ– Dockerã€‚

-----

## ğŸ“‚ 1. ç›®å½•ç»“æ„è®¾è®¡ (æ ¸å¿ƒ)

è¿™æ˜¯æœ¬æ–¹æ¡ˆçš„çµé­‚ã€‚æˆ‘ä»¬å°†æ‰€æœ‰æœåŠ¡çš„**ç¼–æ’æ–‡ä»¶ (Compose)** å’Œ **æŒä¹…åŒ–æ•°æ® (Data)** èšåˆåœ¨ä¸€èµ·ã€‚

**æ ¹ç›®å½•ï¼š`/data`**

/data
â”œâ”€â”€ stacks/                  \# æ‰€æœ‰æœåŠ¡çš„â€œå®¶â€
â”‚   â”œâ”€â”€ dockge/              \# ç®¡ç†é¢æ¿
â”‚   â”‚   â”œâ”€â”€ compose.yaml
â”‚   â”‚   â””â”€â”€ data/            \# Dockge è‡ªèº«æ•°æ®
â”‚   â”œâ”€â”€ caddy/               \# ç½‘å…³
â”‚   â”‚   â”œâ”€â”€ compose.yaml
â”‚   â”‚   â”œâ”€â”€ data/            \# è¯ä¹¦å­˜å‚¨
â”‚   â”‚   â””â”€â”€ config/          \# Caddy å…¨å±€é…ç½®
â”‚   â”œâ”€â”€ [æœåŠ¡å]/            \# ä¾‹å¦‚ jellyfin, nextcloud
â”‚   â”‚   â”œâ”€â”€ compose.yaml     \# å®šä¹‰æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€.env             \# ç¯å¢ƒå˜é‡ (å¯†ç ç­‰)
â”‚   â”‚   â””â”€â”€ data/            \# æ•°æ®åº“ã€é…ç½®æ–‡ä»¶ (bind mount)
â”‚   â””â”€â”€...
â””â”€â”€ shared/                  \# è·¨å®¹å™¨å…±äº«çš„å¤§å‹æ–‡ä»¶
â”œâ”€â”€ media/               \# å½±éŸ³åº“ (Movies, TV)
â”œâ”€â”€ downloads/           \# ä¸‹è½½ç¼“å†²åŒº
â””â”€â”€ backups/             \# æœ¬åœ°å¤‡ä»½å½’æ¡£

**âœ… ä¼˜åŒ–ç‚¹**ï¼š

  * **è‡ªåŒ…å« (Self-contained)**ï¼šæ¯ä¸ªæœåŠ¡çš„ `data` å°±åœ¨å®ƒè‡ªå·±çš„ç›®å½•é‡Œï¼ˆä½¿ç”¨ç›¸å¯¹è·¯å¾„æŒ‚è½½ï¼‰ï¼Œåˆ é™¤æœåŠ¡åªéœ€åˆ é™¤æ–‡ä»¶å¤¹ï¼Œæ— æ®‹ç•™ã€‚
  * **åˆ†ç¦»å…±äº«èµ„æº**ï¼š`shared` ç›®å½•ç‹¬ç«‹ï¼Œæ–¹ä¾¿åª’ä½“æœåŠ¡å’Œä¸‹è½½æœåŠ¡åŒæ—¶æŒ‚è½½ï¼Œæ”¯æŒç¡¬é“¾æ¥ï¼ˆHardlinkï¼‰ã€‚

-----

## ğŸ› ï¸ 2. ç³»ç»Ÿåˆå§‹åŒ– (ä¸€æ¬¡æ€§å·¥ä½œ)

åœ¨**æºæœåŠ¡å™¨**å’Œ**ç›®æ ‡æœåŠ¡å™¨**ä¸Šæ‰§è¡Œç›¸åŒçš„åˆå§‹åŒ–ã€‚

### 2.1 æŒ‚è½½ç¡¬ç›˜ & åˆ›å»ºç›®å½•

å‡è®¾æ•°æ®ç›˜æ˜¯ `/dev/sdb` (è¯·æ ¹æ® `lsblk` ç¡®è®¤)ã€‚

```bash
# 1. æ ¼å¼åŒ– (ä»…æ–°ç›˜æ‰§è¡Œ!)
mkfs.ext4 /dev/sdb

# 2. æŒ‚è½½
mkdir -p /data
mount /dev/sdb /data

# 3. å¼€æœºè‡ªåŠ¨æŒ‚è½½ (å†™å…¥ fstab)
echo "UUID=$(blkid -s UUID -o value /dev/sdb) /data ext4 defaults 0 0" >> /etc/fstab

# 4. è®¾ç½®æƒé™ (å…³é”®æ­¥éª¤ï¼šå°† /data å½’å±ç»™å½“å‰ç”¨æˆ·ï¼Œå‡è®¾æ˜¯ uid 1000)
chown -R 1000:1000 /data
chmod -R 755 /data
```

### 2.2 å®‰è£… Docker & å‡†å¤‡ç½‘ç»œ

æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåä¸º `proxynet` çš„å†…éƒ¨ç½‘ç»œï¼Œ**æ‰€æœ‰æœåŠ¡éƒ½ä¸å‘å®¿ä¸»æœºæš´éœ²ç«¯å£**ï¼Œåªé€šè¿‡ Caddy è½¬å‘ï¼Œå¤§å¹…æå‡å®‰å…¨æ€§ã€‚

```bash
# å®‰è£… Docker (å®˜æ–¹è„šæœ¬)
curl -fsSL https://get.docker.com | sh

# åˆ›å»ºä¸“ç”¨ç½‘ç»œ
docker network create proxynet
```

-----

## ğŸš€ 3. æ ¸å¿ƒæœåŠ¡éƒ¨ç½²

### 3.1 éƒ¨ç½² Dockge (ç®¡ç†ä¸­å¿ƒ)

Dockge æ˜¯åŸºäºæ–‡ä»¶çš„ç®¡ç†å·¥å…·ï¼Œå®Œç¾å¥‘åˆæœ¬æ–¹æ¡ˆã€‚

  * ç›®å½•ï¼š`/data/stacks/dockge`
  * æ–‡ä»¶ï¼š`compose.yaml`

<!-- end list -->

```yaml
services:
  dockge:
    image: louislam/dockge:1
    container_name: dockge
    restart: unless-stopped
    ports:
      # åªæš´éœ²ç®¡ç†é¢æ¿ç«¯å£ï¼Œå»ºè®®é€šè¿‡ SSH éš§é“è®¿é—®æˆ–å†å¥—ä¸€å±‚ VPNï¼Œä¹Ÿå¯é€šè¿‡ Caddy æš´éœ²
      - "5001:5001"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      -./data:/app/data
      # âš ï¸ å…³é”®ï¼šè®© Dockge ç®¡ç† /data/stacks ç›®å½•
      - /data/stacks:/data/stacks
    environment:
      - DOCKGE_STACKS_DIR=/data/stacks
    networks:
      - proxynet

networks:
  proxynet:
    external: true
```

å¯åŠ¨ï¼š

```bash
cd /data/stacks/dockge
docker compose up -d
```

è®¿é—® `http://IP:5001`ï¼Œä½ ç°åœ¨çš„ Docker ç®¡ç†ä¸­å¿ƒå·²å°±ç»ªã€‚åç»­æ‰€æœ‰æœåŠ¡éƒ½åœ¨ç½‘é¡µç«¯æ“ä½œã€‚

### 3.2 éƒ¨ç½² Caddy (æµé‡ç½‘å…³)

  * ç›®å½•ï¼š`/data/stacks/caddy`
  * æ–‡ä»¶ï¼š`compose.yaml`

<!-- end list -->

```yaml
services:
  caddy:
    image: caddy:alpine
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      -./Caddyfile:/etc/caddy/Caddyfile
      -./data:/data
      -./config:/config
    networks:
      - proxynet

networks:
  proxynet:
    external: true
```

  * æ–‡ä»¶ï¼š`Caddyfile` (åœ¨åŒç›®å½•ä¸‹)

<!-- end list -->

```caddy
{
    email your@email.com
}

# ç¤ºä¾‹ï¼šé€šè¿‡å®¹å™¨åè‡ªåŠ¨å‘ç°æœåŠ¡
jellyfin.yourdomain.com {
    reverse_proxy jellyfin:8096
}

nextcloud.yourdomain.com {
    # æ³¨æ„ï¼šnextcloud éœ€è¦é…ç½® trusted_domains
    reverse_proxy nextcloud:80 
}
```

-----

## ğŸ“ 4. éƒ¨ç½²æ–°æœåŠ¡ (é»„é‡‘æ ‡å‡†æ¨¡æ¿)

åœ¨ Dockge ä¸­ç‚¹å‡» **"+ Compose"**ï¼Œä½¿ç”¨ä»¥ä¸‹æ¨¡æ¿ã€‚æ­¤æ¨¡æ¿ç¡®ä¿äº†æƒé™ç»Ÿä¸€å’Œæ•°æ®åœ¨æ–‡ä»¶å¤¹å†…ã€‚

**ç¤ºä¾‹ï¼šéƒ¨ç½² Jellyfin**

```yaml
services:
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    environment:
      # âš ï¸ å…³é”®ï¼šç»Ÿä¸€ä½¿ç”¨ UID 1000 (å®¿ä¸»æœºç”¨æˆ·)ï¼Œé¿å…æƒé™é—®é¢˜
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Shanghai
    volumes:
      # 1. é…ç½®æ–‡ä»¶ï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œæ•°æ®å­˜åœ¨ /data/stacks/jellyfin/config
      -./config:/config
      # 2. åª’ä½“æ–‡ä»¶ï¼šä½¿ç”¨ç»å¯¹è·¯å¾„ï¼ŒæŒ‡å‘å…±äº«æ± 
      - /data/shared/media:/media
    networks:
      - proxynet
    # ä¸éœ€è¦ portsï¼Œé€šè¿‡ Caddy è®¿é—®

networks:
  proxynet:
    external: true
```

-----

## ğŸšš 5. è¿ç§»æ“ä½œæŒ‡å— (Promise: ä¸€é”®è¿ç§»)

å½“ä½ è¦æ¢æœåŠ¡å™¨æ—¶ï¼Œåªéœ€æ‰§è¡Œä»¥ä¸‹ä¸‰æ­¥ã€‚

### æ­¥éª¤ 1ï¼šæ—§æœåŠ¡å™¨ (Old Server) - åœæ­¢ä¸å¿«ç…§

ä¸ºäº†ä¿è¯æ•°æ®åº“ï¼ˆå¦‚ SQLite, MySQLï¼‰çš„æ•°æ®å®Œæ•´æ€§ï¼Œä¼ è¾“å‰å¿…é¡»åœæ­¢å®¹å™¨ã€‚

```bash
# 1. åœæ­¢æ‰€æœ‰å®¹å™¨ (é˜²æ­¢æ•°æ®å†™å…¥ä¸­è¢«æ‹·è´)
docker stop $(docker ps -a -q)

# 2. (å¯é€‰) æ¸…ç†åƒåœ¾
docker system prune -f
```

### æ­¥éª¤ 2ï¼šæ•°æ®åŒæ­¥ (Sync)

ä½¿ç”¨ `rsync` ç›´æ¥å°†æ•´ä¸ª `/data` ç›®å½•æ¨é€åˆ°æ–°æœåŠ¡å™¨ã€‚

```bash
# åœ¨æ—§æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
# å‚æ•°è¯´æ˜ï¼š
# -a: å½’æ¡£æ¨¡å¼ (ä¿ç•™æƒé™ã€æ—¶é—´ç­‰)
# -v: æ˜¾ç¤ºè¿›åº¦
# -z: å‹ç¼©ä¼ è¾“
# --delete: ç¡®ä¿æ–°æœåŠ¡å™¨å’Œæ—§æœåŠ¡å™¨å®Œå…¨ä¸€è‡´ (åˆ é™¤æ–°æœåŠ¡å™¨å¤šä½™æ–‡ä»¶)
rsync -avz --delete /data/ root@æ–°æœåŠ¡å™¨IP:/data/
```

### æ­¥éª¤ 3ï¼šæ–°æœåŠ¡å™¨ (New Server) - å¤æ´»

```bash
# 1. ç¡®ä¿ Docker å·²å®‰è£…ï¼Œç½‘ç»œå·²åˆ›å»º
docker network create proxynet |

| true

# 2. å¯åŠ¨ Dockge
cd /data/stacks/dockge
docker compose up -d

# 3. å¤æ´»å…¶ä½™æœåŠ¡
# ç™»å½•æ–°æœåŠ¡å™¨ Dockge é¢æ¿ (IP:5001)
# ç‚¹å‡»å³ä¸Šè§’ "Scan Stacks Folder" (æ‰«æå †æ ˆæ–‡ä»¶å¤¹)
# æ‰€æœ‰çš„æœåŠ¡ï¼ˆJellyfin, Caddy ç­‰ï¼‰ä¼šè‡ªåŠ¨å‡ºç°ã€‚
# ç‚¹å‡» "Update All" æˆ–é€ä¸ªå¯åŠ¨ã€‚
```

-----

## ğŸ’¡ æ–¹æ¡ˆä¼˜åŠ¿æ€»ç»“

1.  **çœŸæ­£çš„å¯ç§»æ¤æ€§**ï¼šæˆ‘ä»¬æ²¡æœ‰è¿ç§» `/var/lib/docker`ï¼ˆåŒ…å«é•œåƒå±‚å’Œå®¹å™¨ä¸´æ—¶å±‚ï¼‰ã€‚è¿™é¿å…äº†æ–°æ—§æœåŠ¡å™¨ Docker ç‰ˆæœ¬ã€å­˜å‚¨é©±åŠ¨ï¼ˆOverlay2ï¼‰ã€å†…æ ¸ç‰ˆæœ¬ä¸å…¼å®¹å¯¼è‡´ Docker æ— æ³•å¯åŠ¨çš„é—®é¢˜ã€‚**Docker é•œåƒåœ¨æ–°æœåŠ¡å™¨é¦–æ¬¡å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨é‡æ–°æ‹‰å–ï¼Œè¿™æ›´å¹²å‡€ã€æ›´ç¨³å®šã€‚**
2.  **ç›¸å¯¹è·¯å¾„é­”æ³•**ï¼šæœåŠ¡é…ç½®ï¼ˆ`./config`ï¼‰éš `compose.yaml` ç§»åŠ¨ï¼Œæ— è®ºä½ æŠŠæ–‡ä»¶å¤¹æ‹·è´åˆ°å“ªé‡Œï¼Œåªè¦ç›¸å¯¹ç»“æ„ä¸å˜ï¼ŒæœåŠ¡å°±èƒ½è·‘ã€‚
3.  **æƒé™ç»Ÿä¸€**ï¼šé€šè¿‡ `PUID=1000` æˆ– `chown 1000:1000`ï¼Œæ‰€æœ‰æŒä¹…åŒ–æ–‡ä»¶åœ¨å®¿ä¸»æœºä¸Šéƒ½æ˜¯å¯è§ã€å¯ç¼–è¾‘çš„ï¼Œå†ä¹Ÿä¸ä¼šé‡åˆ° `root` é”æ­»æ–‡ä»¶æ— æ³•å¤‡ä»½çš„æƒ…å†µã€‚

**ç°åœ¨ï¼Œä½ çš„æœåŠ¡å™¨å·²ç»å˜æˆäº†â€œæ— çŠ¶æ€â€çš„è®¡ç®—èŠ‚ç‚¹ï¼Œæ‰€æœ‰ä»·å€¼éƒ½å‡èšåœ¨ `/data` è¿™ä¸€ä»½èµ„äº§ä¸­ã€‚**
