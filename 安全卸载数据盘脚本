#!/bin/bash
# 安全卸载数据盘脚本
# 使用方法: sudo bash unmount-disk.sh

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}=========================================="
echo "        数据盘卸载工具"
echo -e "==========================================${NC}\n"

# 检查 root 权限
if [ "$EUID" -ne 0 ]; then 
    echo -e "${RED}❌ 请使用 root 权限运行: sudo bash $0${NC}"
    exit 1
fi

MOUNT_POINT="/data"

# ==================== 步骤 1: 检查挂载状态 ====================
echo -e "${GREEN}🔍 检查 $MOUNT_POINT 挂载状态...${NC}\n"

if ! mountpoint -q "$MOUNT_POINT" 2>/dev/null; then
    echo -e "${YELLOW}⚠ $MOUNT_POINT 未挂载任何设备${NC}"
    
    # 检查 fstab 中是否有配置
    if grep -q "$MOUNT_POINT" /etc/fstab 2>/dev/null; then
        echo -e "${YELLOW}但在 /etc/fstab 中发现配置，是否清理？${NC}"
        read -p "清理 fstab 配置? (y/n): " clean_fstab
        if [[ "$clean_fstab" =~ ^[Yy]$ ]]; then
            cp /etc/fstab /etc/fstab.backup.$(date +%Y%m%d_%H%M%S)
            sed -i "\|$MOUNT_POINT|d" /etc/fstab
            echo -e "${GREEN}✓ 已清理 fstab 配置${NC}"
        fi
    fi
    exit 0
fi

# 获取挂载设备信息
DEVICE=$(df "$MOUNT_POINT" | tail -1 | awk '{print $1}')
USED=$(df -h "$MOUNT_POINT" | tail -1 | awk '{print $3}')
AVAIL=$(df -h "$MOUNT_POINT" | tail -1 | awk '{print $4}')
USE_PERCENT=$(df -h "$MOUNT_POINT" | tail -1 | awk '{print $5}')

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}当前挂载信息:${NC}"
echo "  设备:     $DEVICE"
echo "  挂载点:   $MOUNT_POINT"
echo "  已使用:   $USED"
echo "  可用:     $AVAIL"
echo "  使用率:   $USE_PERCENT"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# ==================== 步骤 2: 检查占用进程 ====================
echo -e "${GREEN}🔍 检查是否有进程正在使用 $MOUNT_POINT...${NC}\n"

if lsof "$MOUNT_POINT" 2>/dev/null | grep -q "$MOUNT_POINT"; then
    echo -e "${YELLOW}⚠ 发现以下进程正在使用该目录:${NC}\n"
    lsof "$MOUNT_POINT" 2>/dev/null || true
    echo ""
    echo -e "${YELLOW}建议先停止这些进程，或使用强制卸载${NC}"
    echo ""
    read -p "是否强制卸载? (y/n): " force_unmount
    if [[ ! "$force_unmount" =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}⚠ 操作已取消${NC}"
        exit 0
    fi
    FORCE_FLAG="-l"  # lazy unmount
else
    echo -e "${GREEN}✓ 没有进程占用${NC}"
    FORCE_FLAG=""
fi

# ==================== 步骤 3: 数据备份提醒 ====================
echo ""
if [ "$USED" != "0" ] && [ "$USED" != "0B" ]; then
    echo -e "${RED}⚠️  警告: 该磁盘中有数据 (已使用 $USED)${NC}"
    echo -e "${RED}⚠️  卸载后数据仍在磁盘上，但无法访问${NC}"
    echo -e "${RED}⚠️  重新挂载可以恢复访问${NC}"
    echo ""
    read -p "确认继续卸载? (输入 YES 继续): " confirm
    if [ "$confirm" != "YES" ]; then
        echo -e "${YELLOW}⚠ 操作已取消${NC}"
        exit 0
    fi
fi

# ==================== 步骤 4: 卸载磁盘 ====================
echo ""
echo -e "${GREEN}📤 正在卸载 $MOUNT_POINT...${NC}"

if umount $FORCE_FLAG "$MOUNT_POINT" 2>/dev/null; then
    echo -e "${GREEN}✓ 卸载成功${NC}"
else
    echo -e "${RED}❌ 卸载失败，尝试强制卸载...${NC}"
    if umount -l "$MOUNT_POINT" 2>/dev/null; then
        echo -e "${GREEN}✓ 强制卸载成功${NC}"
    else
        echo -e "${RED}❌ 强制卸载失败${NC}"
        echo "可能需要重启系统才能完全释放"
        exit 1
    fi
fi

# ==================== 步骤 5: 清理 fstab 配置 ====================
echo ""
echo -e "${GREEN}🗑️  清理 /etc/fstab 配置...${NC}"

# 备份 fstab
BACKUP_FILE="/etc/fstab.backup.$(date +%Y%m%d_%H%M%S)"
cp /etc/fstab "$BACKUP_FILE"
echo "   备份文件: $BACKUP_FILE"

# 删除包含 /data 的行
if grep -q "$MOUNT_POINT" /etc/fstab; then
    sed -i.bak "\|$MOUNT_POINT|d" /etc/fstab
    echo -e "${GREEN}✓ 已从 fstab 中删除自动挂载配置${NC}"
else
    echo -e "${YELLOW}⚠ fstab 中未找到相关配置${NC}"
fi

# ==================== 步骤 6: 询问是否删除目录 ====================
echo ""
read -p "是否删除 $MOUNT_POINT 目录? (y/n): " delete_dir

if [[ "$delete_dir" =~ ^[Yy]$ ]]; then
    if [ -d "$MOUNT_POINT" ]; then
        # 检查目录是否为空
        if [ "$(ls -A $MOUNT_POINT)" ]; then
            echo -e "${RED}⚠️  警告: 目录不为空${NC}"
            ls -lah "$MOUNT_POINT"
            echo ""
            read -p "确认删除非空目录? (输入 YES): " confirm_delete
            if [ "$confirm_delete" = "YES" ]; then
                rm -rf "$MOUNT_POINT"
                echo -e "${GREEN}✓ 目录已删除${NC}"
            else
                echo -e "${YELLOW}⚠ 保留目录 $MOUNT_POINT${NC}"
            fi
        else
            rmdir "$MOUNT_POINT"
            echo -e "${GREEN}✓ 目录已删除${NC}"
        fi
    fi
else
    echo -e "${YELLOW}⚠ 保留目录 $MOUNT_POINT${NC}"
fi

# ==================== 步骤 7: 完成 ====================
echo ""
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}✅ 卸载完成！${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
echo "📊 操作摘要:"
echo "   原设备: $DEVICE"
echo "   挂载点: $MOUNT_POINT (已卸载)"
echo "   fstab:  已清理"
echo ""
echo -e "${YELLOW}💡 提示:${NC}"
echo "   - 磁盘 $DEVICE 上的数据仍然保留"
echo "   - 重新挂载可以恢复访问"
echo "   - 如需彻底清除数据，请手动格式化磁盘"
echo ""
